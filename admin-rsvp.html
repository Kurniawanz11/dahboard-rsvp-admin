<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin RSVP Dashboard</title>
  <style>
    body {font-family: Arial, sans-serif; padding: 20px; background: #f4f6f9;}
    h2 {color:#2c3e50;}
    table {width:100%; border-collapse: collapse; margin-top: 20px;}
    th, td {border:1px solid #ccc; padding:8px; text-align:left;}
    th {background:#2c3e50; color:white;}
    tr:nth-child(even){background:#f9f9f9;}
    .form-row {margin-bottom:10px;}
    input, select, button {padding:6px; margin-right:5px;}
    button {cursor:pointer;}
  </style>
</head>
<body>
  <h2>Admin RSVP</h2>

  <!-- Form Tambah Data -->
  <div>
    <div class="form-row">
      <input id="addNama" placeholder="Nama Lengkap" />
      <select id="addHub">
        <option value="Primary">Primary</option>
        <option value="Guest">Guest</option>
      </select>
      <select id="addStat">
        <option value="Hadir">Hadir</option>
        <option value="Tidak Hadir">Tidak Hadir</option>
      </select>
      <input id="addJml" type="number" placeholder="Jumlah" min="1"/>
      <button id="addBtn">Tambah</button>
    </div>
  </div>

  <!-- Tabel Data RSVP -->
  <table>
    <thead>
      <tr>
        <th>Nama</th>
        <th>Hubungan</th>
        <th>Kehadiran</th>
        <th>Jumlah</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>

<script>
//=== Konfigurasi API Google Apps Script ===
const API = "https://script.google.com/macros/s/AKfycbxMLG7Eihm81qig2_14MFhmYWe6KYH3hpoI8k-G3ejwc3FfCoJnrkgIbqYZGxi7Jow/exec";

//=== Load Data dari Sheet ===
async function load(){
  try {
    const res = await fetch(API + "?action=list");
    const data = await res.json();
    const tbody = document.getElementById('dataBody');
    tbody.innerHTML = "";
    (data.data || []).forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.fullName||''}</td>
        <td>${row.hubungan||''}</td>
        <td>${row.kehadiran||''}</td>
        <td>${row.jumlah||''}</td>
        <td>
          <button onclick="editGuest('${row.fullName}')">Edit</button>
          <button onclick="deleteGuest('${row.fullName}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch(err){
    console.error("Load error:", err);
    alert("Gagal memuat data");
  }
}

//=== Tambah Data ===
document.getElementById('addBtn').onclick = async () => {
  try {
    const nama = (document.getElementById('addNama').value || "").trim();
    const hub = document.getElementById('addHub').value;
    const stat = document.getElementById('addStat').value;
    const jml = document.getElementById('addJml').value;

    if (!nama) return alert("Nama wajib diisi");

    // Pisahkan firstName dan lastName
    const parts = nama.split(" ");
    const first = parts[0] || "";
    const last = parts.slice(1).join(" ");

    const params = new URLSearchParams({
      action: 'add',
      fullName: nama,
      firstName: first,
      lastName: last,
      hubungan: hub,
      kehadiran: stat,
      jumlah: jml
    });

    const res = await fetch(API, { method: "POST", body: params });
    let data = null;
    try { data = await res.json(); } catch(e){}

    if (res.ok && data && data.status === 'success') {
      alert('✅ Data berhasil ditambahkan');
      document.getElementById('addNama').value = "";
      document.getElementById('addJml').value = "";
      await load();
    } else {
      console.warn("Add response:", data);
      alert('❌ Gagal menambahkan data');
    }
  } catch (err) {
    console.error('addBtn error', err);
    alert('❌ Error: ' + err.message);
  }
};

//=== Edit Data ===
async function editGuest(nama){
  const kehadiran = prompt("Masukkan status kehadiran (Hadir/Tidak Hadir):");
  const jumlah = prompt("Masukkan jumlah tamu:");

  if(!kehadiran && !jumlah) return;

  const params = new URLSearchParams({
    action:'update',
    name:nama,
    kehadiran:kehadiran || "",
    jumlah:jumlah || ""
  });

  try{
    const res = await fetch(API, { method:"POST", body: params });
    const data = await res.json();
    if(data.status === "updated" || data.status === "success"){
      alert("✅ Data berhasil diupdate");
      await load();
    } else {
      alert("❌ Gagal update");
    }
  }catch(err){
    console.error("update error", err);
    alert("❌ Error update: " + err.message);
  }
}

//=== Hapus Data ===
async function deleteGuest(nama){
  if(!confirm("Yakin hapus " + nama + "?")) return;
  const params = new URLSearchParams({ action:'delete', name:nama });
  try{
    const res = await fetch(API, { method:"POST", body: params });
    const data = await res.json();
    if(data.status === "deleted" || data.status === "success"){
      alert("✅ Data dihapus");
      await load();
    } else {
      alert("❌ Gagal hapus");
    }
  }catch(err){
    console.error("delete error", err);
    alert("❌ Error hapus: " + err.message);
  }
}

//=== Load pertama kali ===
load();
</script>
</body>
</html>
