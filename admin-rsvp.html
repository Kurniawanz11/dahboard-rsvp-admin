<!doctype html>
<html lang="id">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RSVP Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{font-family:system-ui,sans-serif;background:#f6f7fb;margin:0;padding:24px}
  h1{margin-bottom:8px}
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px}
  input,select,button{padding:10px;border:1px solid #ddd;border-radius:8px}
  button{cursor:pointer;font-weight:600}
  button.primary{background:#2c3e50;color:#fff;border:0}
  .card{background:#fff;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:16px;margin-bottom:20px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #eee;font-size:14px;text-align:left}
  th{background:#2c3e50;color:#fff;position:sticky;top:0}
  tbody tr:hover{background:#f8f9fc}
</style>

<h1>RSVP Dashboard</h1>

<div class="bar">
  <input id="q" placeholder="Cari nama."/>
  <select id="filter">
    <option value="">Semua status</option>
    <option>Hadir</option>
    <option>Tidak Hadir</option>
    <option>-</option>
  </select>
  <button id="refresh" class="primary">Refresh</button>
  <button id="export">Export CSV</button>
  <input type="file" id="importFile"/>
</div>

<div class="card">
  <h3>Tambah Data Baru</h3>
  <div class="bar">
    <input id="addNama" placeholder="Nama"/>
    <select id="addHub">
      <option>Teman</option>
      <option>Saudara</option>
      <option>Tamu</option>
    </select>
    <select id="addStat">
      <option>-</option>
      <option>Hadir</option>
      <option>Tidak Hadir</option>
    </select>
    <input id="addJml" type="number" placeholder="Jumlah"/>
    <!-- PENTING: type="button" supaya tidak melakukan submit/reload -->
    <button type="button" id="addBtn" class="primary">Tambah</button>
  </div>
</div>

<div class="card">
  <div id="count">Memuat data…</div>
  <div style="overflow:auto;max-height:60vh">
    <table id="tbl">
      <thead><tr>
        <th>Timestamp</th><th>Nama</th><th>Hubungan</th><th>Status</th><th>Jumlah</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Statistik Kehadiran</h3>
  <canvas id="chartStatus" height="100"></canvas>
</div>

<script>
/* -- GANTI API ini dengan URL deploy script Anda jika beda -- */
const API = "https://script.google.com/macros/s/AKfycbxMLG7Eihm81qig2_14MFhmYWe6KYH3hpoI8k-G3ejwc3FfCoJnrkgIbqYZGxi7Jow/exec";
let raw = [];

/* load list */
async function load(){
  document.getElementById('count').textContent = "Memuat data…";
  try {
    const res = await fetch(API + "?action=list");
    const json = await res.json();
    raw = json.data || [];
    render();
  } catch (err) {
    console.error('Load error:', err);
    alert('Gagal memuat data. Cek console (F12) Network.');
  }
}

/* render table dan filter */
function render(){
  const q = (document.getElementById('q').value||'').toLowerCase();
  const f = document.getElementById('filter').value;
  const rows = raw.filter(r=>{
    const nama = ((r.fullName) || ((r.firstName||'') + " " + (r.lastName||'')) || "").toLowerCase();
    const okQ = !q || nama.includes(q);
    const okF = !f || (r.kehadiran||'-')===f;
    return okQ && okF;
  });
  document.getElementById('count').textContent = `Total: ${rows.length} data`;
  document.querySelector('#tbl tbody').innerHTML = rows.map(r=>`
    <tr>
      <td>${r.timestamp||''}</td>
      <td>${r.fullName || ((r.firstName||'') + " " + (r.lastName||''))||''}</td>
      <td>${r.hubungan||''}</td>
      <td>${r.kehadiran||''}</td>
      <td>${r.jumlah||''}</td>
    </tr>`).join('');
  drawChart(rows);
}

/* export CSV */
document.getElementById('export').onclick = ()=>{
  const rows=[['Timestamp','Nama','Hubungan','Status','Jumlah']]
    .concat(raw.map(r=>[r.timestamp, r.fullName || ((r.firstName||'') + " " + (r.lastName||'')), r.hubungan, r.kehadiran, r.jumlah]));
  const csv = rows.map(r=>r.map(x=>`"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'rsvp.csv'; a.click(); URL.revokeObjectURL(a.href);
};

/* import CSV - kirim sebagai FormData supaya Apps Script mudah baca */
document.getElementById('importFile').onchange = async e=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  try {
    const fd = new FormData();
    fd.append('action','import');
    fd.append('csv', text);
    const res = await fetch(API, { method: 'POST', body: fd, mode:'cors', credentials:'omit' });
    const json = await res.json();
    console.log('Import response:', json);
    load();
  } catch(err){
    console.error('Import error:', err);
    alert('Gagal import. Cek console.');
  }
};

/* === PERBAIKAN: Tambah Data menggunakan FormData (hindari Invalid action) === */
document.getElementById('addBtn').onclick = async (evt) => {
  // jika tombol berada dalam form di embed Blogger, preventDefault aman dilakukan
  try { evt.preventDefault && evt.preventDefault(); } catch(e){}
  const nama = (document.getElementById('addNama').value||'').trim();
  const hub  = document.getElementById('addHub').value;
  const stat = document.getElementById('addStat').value;
  const jml  = document.getElementById('addJml').value;
  if (!nama) return alert("Nama wajib diisi");

  // make FormData (multipart/form-data) — ini lebih kompatibel dengan Apps Script yang mem-parsing FormData
  const fd = new FormData();
  fd.append('action','add');
  fd.append('nama', nama);           // sesuai yang script GS Anda periksa: data.nama
  fd.append('hubungan', hub);
  fd.append('kehadiran', stat);
  fd.append('jumlah', jml);

  try {
    const res = await fetch(API, { method: 'POST', body: fd, mode:'cors', credentials:'omit' });
    const data = await res.json();
    console.log('Add response:', data); // buka console untuk debugging
    if (data.status === 'ok' || data.status === 'success' || data.status === 'saved' || data.status === 'Tersimpan') {
      alert('Berhasil menambahkan data');
      document.getElementById('addNama').value = "";
      document.getElementById('addJml').value = "";
      load();
    } else {
      // server mengembalikan error
      alert('Gagal menambah: ' + (data.message || JSON.stringify(data)));
    }
  } catch (err) {
    console.error('Add error:', err);
    alert('Error ketika menambah data. Cek console (F12) > Network & Console untuk detail.');
  }
};

/* chart helper */
let chart;
function drawChart(rows){
  const counts={Hadir:0,"Tidak Hadir":0,"-":0};
  rows.forEach(r=>counts[r.kehadiran||'-']++);
  const ctx=document.getElementById('chartStatus').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'pie',
    data:{
      labels:Object.keys(counts),
      datasets:[{data:Object.values(counts)}]
    }
  });
}

  async function deleteGuest(nama){
  if(!confirm("Yakin hapus " + nama + "?")) return;

  // Gunakan FormData agar kompatibel dengan Apps Script
  const fd = new FormData();
  fd.append("action","delete");
  fd.append("fullName", nama); // sesuai dengan addGuest yang menyimpan fullName
  fd.append("nama", nama);     // tambahan fallback, jaga2 jika script backend baca 'nama'

  try {
    const res = await fetch(API, { method:"POST", body: fd });
    const data = await res.json();
    console.log("Delete response:", data);

    if(data.status === "deleted" || data.status === "success" || data.status === "ok"){
      alert("✅ Data dihapus");
      await load();
    } else {
      alert("❌ Gagal hapus: " + (data.message || JSON.stringify(data)));
    }
  }catch(err){
    console.error("delete error", err);
    alert("❌ Error hapus: " + err.message);
  }
}

/* events */
document.getElementById('refresh').onclick = load;
document.getElementById('q').oninput = render;
document.getElementById('filter').onchange = render;

/* initial load */
load();
</script>
</html>
